<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `src/uu/tail/src/follow/watch.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>watch.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../source-script.js"></script><script defer src="../../../source-files.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../uu_tail/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../uu_tail/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../uu_tail/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
</pre><pre class="rust"><code><span class="comment">//  * This file is part of the uutils coreutils package.
//  *
//  * For the full copyright and license information, please view the LICENSE
//  * file that was distributed with this source code.

// spell-checker:ignore (ToDO) tailable untailable stdlib kqueue Uncategorized unwatch

</span><span class="kw">use </span><span class="kw">crate</span>::args::{FollowMode, Settings};
<span class="kw">use </span><span class="kw">crate</span>::follow::files::{FileHandling, PathData};
<span class="kw">use </span><span class="kw">crate</span>::paths::{Input, InputKind, MetadataExtTail, PathExtTail};
<span class="kw">use crate</span>::{platform, text};
<span class="kw">use </span>notify::{RecommendedWatcher, RecursiveMode, Watcher, WatcherKind};
<span class="kw">use </span>std::collections::VecDeque;
<span class="kw">use </span>std::io::BufRead;
<span class="kw">use </span>std::path::{Path, PathBuf};
<span class="kw">use </span>std::sync::mpsc;
<span class="kw">use </span>std::sync::mpsc::{channel, Receiver};
<span class="kw">use </span>uucore::display::Quotable;
<span class="kw">use </span>uucore::error::{set_exit_code, UResult, USimpleError};
<span class="kw">use </span>uucore::show_error;

<span class="kw">pub struct </span>WatcherRx {
    watcher: Box&lt;<span class="kw">dyn </span>Watcher&gt;,
    receiver: Receiver&lt;<span class="prelude-ty">Result</span>&lt;notify::Event, notify::Error&gt;&gt;,
}

<span class="kw">impl </span>WatcherRx {
    <span class="kw">fn </span>new(
        watcher: Box&lt;<span class="kw">dyn </span>Watcher&gt;,
        receiver: Receiver&lt;<span class="prelude-ty">Result</span>&lt;notify::Event, notify::Error&gt;&gt;,
    ) -&gt; <span class="self">Self </span>{
        <span class="self">Self </span>{ watcher, receiver }
    }

    <span class="doccomment">/// Wrapper for `notify::Watcher::watch` to also add the parent directory of `path` if necessary.
    </span><span class="kw">fn </span>watch_with_parent(<span class="kw-2">&amp;mut </span><span class="self">self</span>, path: <span class="kw-2">&amp;</span>Path) -&gt; UResult&lt;()&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>path = path.to_owned();
        <span class="attribute">#[cfg(target_os = <span class="string">&quot;linux&quot;</span>)]
        </span><span class="kw">if </span>path.is_file() {
            <span class="comment">/*
            NOTE: Using the parent directory instead of the file is a workaround.
            This workaround follows the recommendation of the notify crate authors:
            &gt; On some platforms, if the `path` is renamed or removed while being watched, behavior may
            &gt; be unexpected. See discussions in [#165] and [#166]. If less surprising behavior is wanted
            &gt; one may non-recursively watch the _parent_ directory as well and manage related events.
            NOTE: Adding both: file and parent results in duplicate/wrong events.
            Tested for notify::InotifyWatcher and for notify::PollWatcher.
            */
            </span><span class="kw">if let </span><span class="prelude-val">Some</span>(parent) = path.parent() {
                <span class="kw">if </span>parent.is_dir() {
                    path = parent.to_owned();
                } <span class="kw">else </span>{
                    path = PathBuf::from(<span class="string">&quot;.&quot;</span>);
                }
            } <span class="kw">else </span>{
                <span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(
                    <span class="number">1</span>,
                    <span class="macro">format!</span>(<span class="string">&quot;cannot watch parent directory of {}&quot;</span>, path.display()),
                ));
            };
        }
        <span class="kw">if </span>path.is_relative() {
            path = path.canonicalize()<span class="question-mark">?</span>;
        }

        <span class="comment">// for syscalls: 2x &quot;inotify_add_watch&quot; (&quot;filename&quot; and &quot;.&quot;) and 1x &quot;inotify_rm_watch&quot;
        </span><span class="self">self</span>.watch(<span class="kw-2">&amp;</span>path, RecursiveMode::NonRecursive)<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">fn </span>watch(<span class="kw-2">&amp;mut </span><span class="self">self</span>, path: <span class="kw-2">&amp;</span>Path, mode: RecursiveMode) -&gt; UResult&lt;()&gt; {
        <span class="self">self</span>.watcher
            .watch(path, mode)
            .map_err(|err| USimpleError::new(<span class="number">1</span>, err.to_string()))
    }

    <span class="kw">fn </span>unwatch(<span class="kw-2">&amp;mut </span><span class="self">self</span>, path: <span class="kw-2">&amp;</span>Path) -&gt; UResult&lt;()&gt; {
        <span class="self">self</span>.watcher
            .unwatch(path)
            .map_err(|err| USimpleError::new(<span class="number">1</span>, err.to_string()))
    }
}

<span class="kw">pub struct </span>WatcherService {
    <span class="doccomment">/// Whether --retry was given on the command line
    </span><span class="kw">pub </span>retry: bool,

    <span class="doccomment">/// The [`FollowMode`]
    </span><span class="kw">pub </span>follow: <span class="prelude-ty">Option</span>&lt;FollowMode&gt;,

    <span class="doccomment">/// Indicates whether to use the fallback `polling` method instead of the
    /// platform specific event driven method. Since `use_polling` is subject to
    /// change during runtime it is moved out of [`Settings`].
    </span><span class="kw">pub </span>use_polling: bool,
    <span class="kw">pub </span>watcher_rx: <span class="prelude-ty">Option</span>&lt;WatcherRx&gt;,
    <span class="kw">pub </span>orphans: Vec&lt;PathBuf&gt;,
    <span class="kw">pub </span>files: FileHandling,
}

<span class="kw">impl </span>WatcherService {
    <span class="kw">pub fn </span>new(
        retry: bool,
        follow: <span class="prelude-ty">Option</span>&lt;FollowMode&gt;,
        use_polling: bool,
        files: FileHandling,
    ) -&gt; <span class="self">Self </span>{
        <span class="self">Self </span>{
            retry,
            follow,
            use_polling,
            watcher_rx: <span class="prelude-val">None</span>,
            orphans: Vec::new(),
            files,
        }
    }

    <span class="kw">pub fn </span>from(settings: <span class="kw-2">&amp;</span>Settings) -&gt; <span class="self">Self </span>{
        <span class="self">Self</span>::new(
            settings.retry,
            settings.follow,
            settings.use_polling,
            FileHandling::from(settings),
        )
    }

    <span class="kw">pub fn </span>add_path(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        path: <span class="kw-2">&amp;</span>Path,
        display_name: <span class="kw-2">&amp;</span>str,
        reader: <span class="prelude-ty">Option</span>&lt;Box&lt;<span class="kw">dyn </span>BufRead&gt;&gt;,
        update_last: bool,
    ) -&gt; UResult&lt;()&gt; {
        <span class="kw">if </span><span class="self">self</span>.follow.is_some() {
            <span class="kw">let </span>path = <span class="kw">if </span>path.is_relative() {
                std::env::current_dir()<span class="question-mark">?</span>.join(path)
            } <span class="kw">else </span>{
                path.to_owned()
            };
            <span class="kw">let </span>metadata = path.metadata().ok();
            <span class="self">self</span>.files.insert(
                <span class="kw-2">&amp;</span>path,
                PathData::new(reader, metadata, display_name),
                update_last,
            );
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub fn </span>add_stdin(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        display_name: <span class="kw-2">&amp;</span>str,
        reader: <span class="prelude-ty">Option</span>&lt;Box&lt;<span class="kw">dyn </span>BufRead&gt;&gt;,
        update_last: bool,
    ) -&gt; UResult&lt;()&gt; {
        <span class="kw">if </span><span class="self">self</span>.follow == <span class="prelude-val">Some</span>(FollowMode::Descriptor) {
            <span class="kw">return </span><span class="self">self</span>.add_path(
                <span class="kw-2">&amp;</span>PathBuf::from(text::DEV_STDIN),
                display_name,
                reader,
                update_last,
            );
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub fn </span>add_bad_path(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        path: <span class="kw-2">&amp;</span>Path,
        display_name: <span class="kw-2">&amp;</span>str,
        update_last: bool,
    ) -&gt; UResult&lt;()&gt; {
        <span class="kw">if </span><span class="self">self</span>.retry &amp;&amp; <span class="self">self</span>.follow.is_some() {
            <span class="kw">return </span><span class="self">self</span>.add_path(path, display_name, <span class="prelude-val">None</span>, update_last);
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub fn </span>start(<span class="kw-2">&amp;mut </span><span class="self">self</span>, settings: <span class="kw-2">&amp;</span>Settings) -&gt; UResult&lt;()&gt; {
        <span class="kw">if </span>settings.follow.is_none() {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>(tx, rx) = channel();

        <span class="comment">/*
        Watcher is implemented per platform using the best implementation available on that
        platform. In addition to such event driven implementations, a polling implementation
        is also provided that should work on any platform.
        Linux / Android: inotify
        macOS: FSEvents / kqueue
        Windows: ReadDirectoryChangesWatcher
        FreeBSD / NetBSD / OpenBSD / DragonflyBSD: kqueue
        Fallback: polling every n seconds

        NOTE:
        We force the use of kqueue with: features=[&quot;macos_kqueue&quot;].
        On macOS only `kqueue` is suitable for our use case because `FSEvents`
        waits for file close util it delivers a modify event. See:
        https://github.com/notify-rs/notify/issues/240
        */

        </span><span class="kw">let </span>watcher: Box&lt;<span class="kw">dyn </span>Watcher&gt;;
        <span class="kw">let </span>watcher_config = notify::Config::default()
            .with_poll_interval(settings.sleep_sec)
            <span class="comment">/*
            NOTE: By enabling compare_contents, performance will be significantly impacted
            as all files will need to be read and hashed at each `poll_interval`.
            However, this is necessary to pass: &quot;gnu/tests/tail-2/F-vs-rename.sh&quot;
            */
            </span>.with_compare_contents(<span class="bool-val">true</span>);
        <span class="kw">if </span><span class="self">self</span>.use_polling || RecommendedWatcher::kind() == WatcherKind::PollWatcher {
            <span class="self">self</span>.use_polling = <span class="bool-val">true</span>; <span class="comment">// We have to use polling because there&#39;s no supported backend
            </span>watcher = Box::new(notify::PollWatcher::new(tx, watcher_config).unwrap());
        } <span class="kw">else </span>{
            <span class="kw">let </span>tx_clone = tx.clone();
            <span class="kw">match </span>notify::RecommendedWatcher::new(tx, notify::Config::default()) {
                <span class="prelude-val">Ok</span>(w) =&gt; watcher = Box::new(w),
                <span class="prelude-val">Err</span>(e) <span class="kw">if </span>e.to_string().starts_with(<span class="string">&quot;Too many open files&quot;</span>) =&gt; {
                    <span class="comment">/*
                    NOTE: This ErrorKind is `Uncategorized`, but it is not recommended
                    to match an error against `Uncategorized`
                    NOTE: Could be tested with decreasing `max_user_instances`, e.g.:
                    `sudo sysctl fs.inotify.max_user_instances=64`
                    */
                    </span><span class="macro">show_error!</span>(
                        <span class="string">&quot;{} cannot be used, reverting to polling: Too many open files&quot;</span>,
                        text::BACKEND
                    );
                    set_exit_code(<span class="number">1</span>);
                    <span class="self">self</span>.use_polling = <span class="bool-val">true</span>;
                    watcher = Box::new(notify::PollWatcher::new(tx_clone, watcher_config).unwrap());
                }
                <span class="prelude-val">Err</span>(e) =&gt; <span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(<span class="number">1</span>, e.to_string())),
            };
        }

        <span class="self">self</span>.watcher_rx = <span class="prelude-val">Some</span>(WatcherRx::new(watcher, rx));
        <span class="self">self</span>.init_files(<span class="kw-2">&amp;</span>settings.inputs)<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub fn </span>follow_descriptor(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; bool {
        <span class="self">self</span>.follow == <span class="prelude-val">Some</span>(FollowMode::Descriptor)
    }

    <span class="kw">pub fn </span>follow_name(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; bool {
        <span class="self">self</span>.follow == <span class="prelude-val">Some</span>(FollowMode::Name)
    }

    <span class="kw">pub fn </span>follow_descriptor_retry(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; bool {
        <span class="self">self</span>.follow_descriptor() &amp;&amp; <span class="self">self</span>.retry
    }

    <span class="kw">pub fn </span>follow_name_retry(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; bool {
        <span class="self">self</span>.follow_name() &amp;&amp; <span class="self">self</span>.retry
    }

    <span class="kw">fn </span>init_files(<span class="kw-2">&amp;mut </span><span class="self">self</span>, inputs: <span class="kw-2">&amp;</span>VecDeque&lt;Input&gt;) -&gt; UResult&lt;()&gt; {
        <span class="kw">if let </span><span class="prelude-val">Some</span>(watcher_rx) = <span class="kw-2">&amp;mut </span><span class="self">self</span>.watcher_rx {
            <span class="kw">for </span>input <span class="kw">in </span>inputs {
                <span class="kw">match </span>input.kind() {
                    InputKind::Stdin =&gt; <span class="kw">continue</span>,
                    InputKind::File(path) =&gt; {
                        <span class="attribute">#[cfg(all(unix, not(target_os = <span class="string">&quot;linux&quot;</span>)))]
                        </span><span class="kw">if </span>!path.is_file() {
                            <span class="kw">continue</span>;
                        }
                        <span class="kw">let </span><span class="kw-2">mut </span>path = path.to_owned();
                        <span class="kw">if </span>path.is_relative() {
                            path = std::env::current_dir()<span class="question-mark">?</span>.join(path);
                        }

                        <span class="kw">if </span>path.is_tailable() {
                            <span class="comment">// Add existing regular files to `Watcher` (InotifyWatcher).
                            </span>watcher_rx.watch_with_parent(<span class="kw-2">&amp;</span>path)<span class="question-mark">?</span>;
                        } <span class="kw">else if </span>!path.is_orphan() {
                            <span class="comment">// If `path` is not a tailable file, add its parent to `Watcher`.
                            </span>watcher_rx
                                .watch(path.parent().unwrap(), RecursiveMode::NonRecursive)<span class="question-mark">?</span>;
                        } <span class="kw">else </span>{
                            <span class="comment">// If there is no parent, add `path` to `orphans`.
                            </span><span class="self">self</span>.orphans.push(path);
                        }
                    }
                }
            }
        }
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">fn </span>handle_event(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        event: <span class="kw-2">&amp;</span>notify::Event,
        settings: <span class="kw-2">&amp;</span>Settings,
    ) -&gt; UResult&lt;Vec&lt;PathBuf&gt;&gt; {
        <span class="kw">use </span>notify::event::<span class="kw-2">*</span>;

        <span class="kw">let </span>event_path = event.paths.first().unwrap();
        <span class="kw">let </span><span class="kw-2">mut </span>paths: Vec&lt;PathBuf&gt; = <span class="macro">vec!</span>[];
        <span class="kw">let </span>display_name = <span class="self">self</span>.files.get(event_path).display_name.clone();

        <span class="kw">match </span>event.kind {
            EventKind::Modify(ModifyKind::Metadata(MetadataKind::Any | MetadataKind::WriteTime))

                <span class="comment">// | EventKind::Access(AccessKind::Close(AccessMode::Write))
                </span>| EventKind::Create(CreateKind::File | CreateKind::Folder | CreateKind::Any)
                | EventKind::Modify(ModifyKind::Data(DataChange::Any))
                | EventKind::Modify(ModifyKind::Name(RenameMode::To)) =&gt; {
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(new_md) = event_path.metadata() {

                        <span class="kw">let </span>is_tailable = new_md.is_tailable();
                        <span class="kw">let </span>pd = <span class="self">self</span>.files.get(event_path);
                        <span class="kw">if let </span><span class="prelude-val">Some</span>(old_md) = <span class="kw-2">&amp;</span>pd.metadata {
                            <span class="kw">if </span>is_tailable {
                                <span class="comment">// We resume tracking from the start of the file,
                                // assuming it has been truncated to 0. This mimics GNU&#39;s `tail`
                                // behavior and is the usual truncation operation for log self.files.
                                </span><span class="kw">if </span>!old_md.is_tailable() {
                                    <span class="macro">show_error!</span>( <span class="string">&quot;{} has become accessible&quot;</span>, display_name.quote());
                                    <span class="self">self</span>.files.update_reader(event_path)<span class="question-mark">?</span>;
                                } <span class="kw">else if </span>pd.reader.is_none() {
                                    <span class="macro">show_error!</span>( <span class="string">&quot;{} has appeared;  following new file&quot;</span>, display_name.quote());
                                    <span class="self">self</span>.files.update_reader(event_path)<span class="question-mark">?</span>;
                                } <span class="kw">else if </span>event.kind == EventKind::Modify(ModifyKind::Name(RenameMode::To))
                                || (<span class="self">self</span>.use_polling
                                &amp;&amp; !old_md.file_id_eq(<span class="kw-2">&amp;</span>new_md)) {
                                    <span class="macro">show_error!</span>( <span class="string">&quot;{} has been replaced;  following new file&quot;</span>, display_name.quote());
                                    <span class="self">self</span>.files.update_reader(event_path)<span class="question-mark">?</span>;
                                } <span class="kw">else if </span>old_md.got_truncated(<span class="kw-2">&amp;</span>new_md)<span class="question-mark">? </span>{
                                    <span class="macro">show_error!</span>(<span class="string">&quot;{}: file truncated&quot;</span>, display_name);
                                    <span class="self">self</span>.files.update_reader(event_path)<span class="question-mark">?</span>;
                                }
                                paths.push(event_path.to_owned());
                            } <span class="kw">else if </span>!is_tailable &amp;&amp; old_md.is_tailable() {
                                <span class="kw">if </span>pd.reader.is_some() {
                                    <span class="self">self</span>.files.reset_reader(event_path);
                                } <span class="kw">else </span>{
                                    <span class="macro">show_error!</span>(
                                        <span class="string">&quot;{} has been replaced with an untailable file&quot;</span>,
                                        display_name.quote()
                                    );
                                }
                            }
                        } <span class="kw">else if </span>is_tailable {
                                <span class="macro">show_error!</span>( <span class="string">&quot;{} has appeared;  following new file&quot;</span>, display_name.quote());
                                <span class="self">self</span>.files.update_reader(event_path)<span class="question-mark">?</span>;
                                paths.push(event_path.to_owned());
                            } <span class="kw">else if </span>settings.retry {
                                <span class="kw">if </span><span class="self">self</span>.follow_descriptor() {
                                    <span class="macro">show_error!</span>(
                                        <span class="string">&quot;{} has been replaced with an untailable file; giving up on this name&quot;</span>,
                                        display_name.quote()
                                    );
                                    <span class="kw">let _ </span>= <span class="self">self</span>.watcher_rx.as_mut().unwrap().watcher.unwatch(event_path);
                                    <span class="self">self</span>.files.remove(event_path);
                                    <span class="kw">if </span><span class="self">self</span>.files.no_files_remaining(settings) {
                                        <span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(<span class="number">1</span>, text::NO_FILES_REMAINING));
                                    }
                                } <span class="kw">else </span>{
                                    <span class="macro">show_error!</span>(
                                        <span class="string">&quot;{} has been replaced with an untailable file&quot;</span>,
                                        display_name.quote()
                                    );
                                }
                            }
                        <span class="self">self</span>.files.update_metadata(event_path, <span class="prelude-val">Some</span>(new_md));
                    }
                }
            EventKind::Remove(RemoveKind::File | RemoveKind::Any)

                <span class="comment">// | EventKind::Modify(ModifyKind::Name(RenameMode::Any))
                </span>| EventKind::Modify(ModifyKind::Name(RenameMode::From)) =&gt; {
                    <span class="kw">if </span><span class="self">self</span>.follow_name() {
                        <span class="kw">if </span>settings.retry {
                            <span class="kw">if let </span><span class="prelude-val">Some</span>(old_md) = <span class="self">self</span>.files.get_mut_metadata(event_path) {
                                <span class="kw">if </span>old_md.is_tailable() &amp;&amp; <span class="self">self</span>.files.get(event_path).reader.is_some() {
                                    <span class="macro">show_error!</span>(
                                        <span class="string">&quot;{} {}: {}&quot;</span>,
                                        display_name.quote(),
                                        text::BECOME_INACCESSIBLE,
                                        text::NO_SUCH_FILE
                                    );
                                }
                            }
                            <span class="kw">if </span>event_path.is_orphan() &amp;&amp; !<span class="self">self</span>.orphans.contains(event_path) {
                                <span class="macro">show_error!</span>(<span class="string">&quot;directory containing watched file was removed&quot;</span>);
                                <span class="macro">show_error!</span>(
                                    <span class="string">&quot;{} cannot be used, reverting to polling&quot;</span>,
                                    text::BACKEND
                                );
                                <span class="self">self</span>.orphans.push(event_path.to_owned());
                                <span class="kw">let _ </span>= <span class="self">self</span>.watcher_rx.as_mut().unwrap().unwatch(event_path);
                            }
                        } <span class="kw">else </span>{
                            <span class="macro">show_error!</span>(<span class="string">&quot;{}: {}&quot;</span>, display_name, text::NO_SUCH_FILE);
                            <span class="kw">if </span>!<span class="self">self</span>.files.files_remaining() &amp;&amp; <span class="self">self</span>.use_polling {
                                <span class="comment">// NOTE: GNU&#39;s tail exits here for `---disable-inotify`
                                </span><span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(<span class="number">1</span>, text::NO_FILES_REMAINING));
                            }
                        }
                        <span class="self">self</span>.files.reset_reader(event_path);
                    } <span class="kw">else if </span><span class="self">self</span>.follow_descriptor_retry() {
                        <span class="comment">// --retry only effective for the initial open
                        </span><span class="kw">let _ </span>= <span class="self">self</span>.watcher_rx.as_mut().unwrap().unwatch(event_path);
                        <span class="self">self</span>.files.remove(event_path);
                    } <span class="kw">else if </span><span class="self">self</span>.use_polling &amp;&amp; event.kind == EventKind::Remove(RemoveKind::Any) {
                        <span class="comment">/*
                        BUG: The watched file was removed. Since we&#39;re using Polling, this
                        could be a rename. We can&#39;t tell because `notify::PollWatcher` doesn&#39;t
                        recognize renames properly.
                        Ideally we want to call seek to offset 0 on the file handle.
                        But because we only have access to `PathData::reader` as `BufRead`,
                        we cannot seek to 0 with `BufReader::seek_relative`.
                        Also because we don&#39;t have the new name, we cannot work around this
                        by simply reopening the file.
                        */
                    </span>}
                }
            EventKind::Modify(ModifyKind::Name(RenameMode::Both)) =&gt; {
                <span class="comment">/*
                NOTE: For `tail -f a`, keep tracking additions to b after `mv a b`
                (gnu/tests/tail-2/descriptor-vs-rename.sh)
                NOTE: The File/BufReader doesn&#39;t need to be updated.
                However, we need to update our `files.map`.
                This can only be done for inotify, because this EventKind does not
                trigger for the PollWatcher.
                BUG: As a result, there&#39;s a bug if polling is used:
                $ tail -f file_a ---disable-inotify
                $ mv file_a file_b
                $ echo A &gt;&gt; file_b
                $ echo A &gt;&gt; file_a
                The last append to file_a is printed, however this shouldn&#39;t be because
                after the &quot;mv&quot; tail should only follow &quot;file_b&quot;.
                TODO: [2022-05; jhscheer] add test for this bug
                */

                </span><span class="kw">if </span><span class="self">self</span>.follow_descriptor() {
                    <span class="kw">let </span>new_path = event.paths.last().unwrap();
                    paths.push(new_path.to_owned());

                    <span class="kw">let </span>new_data = PathData::from_other_with_path(<span class="self">self</span>.files.remove(event_path), new_path);
                    <span class="self">self</span>.files.insert(
                        new_path,
                        new_data,
                        <span class="self">self</span>.files.get_last().unwrap() == event_path
                    );

                    <span class="comment">// Unwatch old path and watch new path
                    </span><span class="kw">let _ </span>= <span class="self">self</span>.watcher_rx.as_mut().unwrap().unwatch(event_path);
                    <span class="self">self</span>.watcher_rx.as_mut().unwrap().watch_with_parent(new_path)<span class="question-mark">?</span>;
                }
            }
            <span class="kw">_ </span>=&gt; {}
        }
        <span class="prelude-val">Ok</span>(paths)
    }
}

<span class="kw">pub fn </span>follow(<span class="kw-2">mut </span>watcher_service: WatcherService, settings: <span class="kw-2">&amp;</span>Settings) -&gt; UResult&lt;()&gt; {
    <span class="kw">if </span>watcher_service.files.no_files_remaining(settings)
        &amp;&amp; !watcher_service.files.only_stdin_remaining()
    {
        <span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(<span class="number">1</span>, text::NO_FILES_REMAINING.to_string()));
    }

    <span class="kw">let </span><span class="kw-2">mut </span>process = platform::ProcessChecker::new(settings.pid);

    <span class="kw">let </span><span class="kw-2">mut </span>_event_counter = <span class="number">0</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>_timeout_counter = <span class="number">0</span>;

    <span class="comment">// main follow loop
    </span><span class="kw">loop </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>_read_some = <span class="bool-val">false</span>;

        <span class="comment">// If `--pid=p`, tail checks whether process p
        // is alive at least every `--sleep-interval=N` seconds
        </span><span class="kw">if </span>settings.follow.is_some() &amp;&amp; settings.pid != <span class="number">0 </span>&amp;&amp; process.is_dead() {
            <span class="comment">// p is dead, tail will also terminate
            </span><span class="kw">break</span>;
        }

        <span class="comment">// For `-F` we need to poll if an orphan path becomes available during runtime.
        // If a path becomes an orphan during runtime, it will be added to orphans.
        // To be able to differentiate between the cases of test_retry8 and test_retry9,
        // here paths will not be removed from orphans if the path becomes available.
        </span><span class="kw">if </span>watcher_service.follow_name_retry() {
            <span class="kw">for </span>new_path <span class="kw">in </span><span class="kw-2">&amp;</span>watcher_service.orphans {
                <span class="kw">if </span>new_path.exists() {
                    <span class="kw">let </span>pd = watcher_service.files.get(new_path);
                    <span class="kw">let </span>md = new_path.metadata().unwrap();
                    <span class="kw">if </span>md.is_tailable() &amp;&amp; pd.reader.is_none() {
                        <span class="macro">show_error!</span>(
                            <span class="string">&quot;{} has appeared;  following new file&quot;</span>,
                            pd.display_name.quote()
                        );
                        watcher_service.files.update_metadata(new_path, <span class="prelude-val">Some</span>(md));
                        watcher_service.files.update_reader(new_path)<span class="question-mark">?</span>;
                        _read_some = watcher_service
                            .files
                            .tail_file(new_path, settings.verbose)<span class="question-mark">?</span>;
                        watcher_service
                            .watcher_rx
                            .as_mut()
                            .unwrap()
                            .watch_with_parent(new_path)<span class="question-mark">?</span>;
                    }
                }
            }
        }

        <span class="comment">// With  -f, sleep for approximately N seconds (default 1.0) between iterations;
        // We wake up if Notify sends an Event or if we wait more than `sleep_sec`.
        </span><span class="kw">let </span>rx_result = watcher_service
            .watcher_rx
            .as_mut()
            .unwrap()
            .receiver
            .recv_timeout(settings.sleep_sec);
        <span class="kw">if </span>rx_result.is_ok() {
            _event_counter += <span class="number">1</span>;
            _timeout_counter = <span class="number">0</span>;
        }

        <span class="kw">let </span><span class="kw-2">mut </span>paths = <span class="macro">vec!</span>[]; <span class="comment">// Paths worth checking for new content to print
        </span><span class="kw">match </span>rx_result {
            <span class="prelude-val">Ok</span>(<span class="prelude-val">Ok</span>(event)) =&gt; {
                <span class="kw">if let </span><span class="prelude-val">Some</span>(event_path) = event.paths.first() {
                    <span class="kw">if </span>watcher_service.files.contains_key(event_path) {
                        <span class="comment">// Handle Event if it is about a path that we are monitoring
                        </span>paths = watcher_service.handle_event(<span class="kw-2">&amp;</span>event, settings)<span class="question-mark">?</span>;
                    }
                }
            }
            <span class="prelude-val">Ok</span>(<span class="prelude-val">Err</span>(notify::Error {
                kind: notify::ErrorKind::Io(<span class="kw-2">ref </span>e),
                paths,
            })) <span class="kw">if </span>e.kind() == std::io::ErrorKind::NotFound =&gt; {
                <span class="kw">if let </span><span class="prelude-val">Some</span>(event_path) = paths.first() {
                    <span class="kw">if </span>watcher_service.files.contains_key(event_path) {
                        <span class="kw">let _ </span>= watcher_service
                            .watcher_rx
                            .as_mut()
                            .unwrap()
                            .watcher
                            .unwatch(event_path);
                    }
                }
            }
            <span class="prelude-val">Ok</span>(<span class="prelude-val">Err</span>(notify::Error {
                kind: notify::ErrorKind::MaxFilesWatch,
                ..
            })) =&gt; {
                <span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(
                    <span class="number">1</span>,
                    <span class="macro">format!</span>(<span class="string">&quot;{} resources exhausted&quot;</span>, text::BACKEND),
                ))
            }
            <span class="prelude-val">Ok</span>(<span class="prelude-val">Err</span>(e)) =&gt; <span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(<span class="number">1</span>, <span class="macro">format!</span>(<span class="string">&quot;NotifyError: {}&quot;</span>, e))),
            <span class="prelude-val">Err</span>(mpsc::RecvTimeoutError::Timeout) =&gt; {
                _timeout_counter += <span class="number">1</span>;
            }
            <span class="prelude-val">Err</span>(e) =&gt; <span class="kw">return </span><span class="prelude-val">Err</span>(USimpleError::new(<span class="number">1</span>, <span class="macro">format!</span>(<span class="string">&quot;RecvTimeoutError: {}&quot;</span>, e))),
        }

        <span class="kw">if </span>watcher_service.use_polling &amp;&amp; settings.follow.is_some() {
            <span class="comment">// Consider all files to potentially have new content.
            // This is a workaround because `Notify::PollWatcher`
            // does not recognize the &quot;renaming&quot; of files.
            </span>paths = watcher_service.files.keys().cloned().collect::&lt;Vec&lt;<span class="kw">_</span>&gt;&gt;();
        }

        <span class="comment">// main print loop
        </span><span class="kw">for </span>path <span class="kw">in </span><span class="kw-2">&amp;</span>paths {
            _read_some = watcher_service.files.tail_file(path, settings.verbose)<span class="question-mark">?</span>;
        }

        <span class="kw">if </span>_timeout_counter == settings.max_unchanged_stats {
            <span class="comment">/*
            TODO: [2021-10; jhscheer] implement timeout_counter for each file.
            ‘--max-unchanged-stats=n’
            When tailing a file by name, if there have been n (default n=5) consecutive iterations
            for which the file has not changed, then open/fstat the file to determine if that file
            name is still associated with the same device/inode-number pair as before. When
            following a log file that is rotated, this is approximately the number of seconds
            between when tail prints the last pre-rotation lines and when it prints the lines that
            have accumulated in the new log file. This option is meaningful only when polling
            (i.e., without inotify) and when following by name.
            */
        </span>}
    }
    <span class="prelude-val">Ok</span>(())
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="uu_tail" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>